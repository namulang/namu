name: CI for main

on:
  push:
    branches: [ test-workflow ]
  pull_request:
    branches: [ test-workflow ]

jobs:
  build-on-linux-gcc:
    name: build on linux
    runs-on: ubuntu-22.04

    steps:
    - name: install native dependencies.
      run: |
        sudo apt-get update
        sudo apt install -y python3 python3-pip cmake wget flex graphviz
        ls .
        sudo wget https://ftp.gnu.org/gnu/bison/bison-3.8.2.tar.gz
        tar -zxvf bison-3.8.2.tar.gz
        cd bison-3.8.2
        ./configure
        sudo make
        sudo make install
        cd ..
        sudo rm -rf bison-3.8.2
        if [ -f /usr/bin/bison ]; then
          sudo mv /usr/bin/bison /usr/bin/bison-prev
        fi
        sudo ln -s /usr/local/bin/bison /usr/bin/bison

    - name: remove clang
      run: |
        which clang++
        if [ $? -ne 0 ]; then
          sudo mv $(which clang++) /tmp
        fi

    - name: checkout repository codes
      uses: actions/checkout@v2

    - name: build in release mode & test current codes.
      run: |
        export C=clang CXX=clang++ PYTHON=$(which python3)
        ls -l ${{github.workspace}}/mod/leaf/parser/bison
        sudo $PYTHON ${{github.workspace}}/build/builder.py pub deb
        sudo $PYTHON ${{github.workspace}}/build/builder.py test

    - name: upload output files.
      uses: actions/upload-artifact@v4
      with:
        name: namu-ubuntu-x64
        path: ${{github.workspace}}/bin/namu-ubuntu-x64.deb
