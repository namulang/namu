name: CI for main

on:
  push:
    branches: [ test-workflow ]
  pull_request:
    branches: [ test-workflow ]

jobs:
  build-on-macos:
    name: build on macos
    runs-on: macos-15-intel

    steps:
    - name: checkout repository codes
      uses: actions/checkout@v4

    - name: install native dependencies.
      run: |
        brew unlink python && brew link --overwrite python
        brew install wget bison flex graphviz llvm
        echo 'export PATH="/opt/homebrew/opt/llvm/bin:$PATH"' >> /Users/runner/.bash_profile
        source /Users/runner/.bash_profile

        echo "install bison"
        sudo wget https://ftp.gnu.org/gnu/bison/bison-3.8.2.tar.gz
        tar -zxvf bison-3.8.2.tar.gz
        cd bison-3.8.2
        ./configure
        sudo make
        sudo make install
        cd ..

    - name: build in release mode & test current codes.
      run: |
        source /Users/runner/.bash_profile
        export PATH="$PATH:/usr/local/opt/flex/bin:/usr/local/opt/bison/bin"
        export C=clang CXX=clang++ PYTHON=$(which python3)
        ls -l ${{github.workspace}}/mod/leaf/parser/bison
        $PYTHON ${{github.workspace}}/build/builder.py pub mac
        $PYTHON ${{github.workspace}}/build/builder.py test

    - name: archive to tar files
      run: tar -cvf namu-macos-x64.tar ${{github.workspace}}/bin/

    - name: upload output files.
      uses: actions/upload-artifact@v4
      with:
        name: namu-macos-x64
        path: namu-macos-x64.tar
